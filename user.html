<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - Oscar 2026 Tracker</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="header" id="header"></header>

  <main class="page">
    <div class="container" style="max-width: 800px;">
      <div id="profile-content">
        <div class="loading">
          <div class="loading__spinner"></div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/data.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/supabase.js"></script>
  <script src="js/app.js"></script>
  <script>
    onReady(async () => {
      const content = document.getElementById('profile-content');
      const username = getUrlParam('u');

      if (!username) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state__icon">[??]</div>
            <h2 class="empty-state__title">User not found</h2>
            <p class="empty-state__text">No username was provided.</p>
            <a href="community.html" class="btn btn--primary">View Community</a>
          </div>
        `;
        return;
      }

      // Fetch user's watched data
      const result = await api_getUserWatched(username);

      if (result.error || !result.user) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state__icon">[??]</div>
            <h2 class="empty-state__title">User not found</h2>
            <p class="empty-state__text">We couldn't find a user with that username.</p>
            <a href="community.html" class="btn btn--primary">View Community</a>
          </div>
        `;
        return;
      }

      const user = result.user;
      const watchedList = result.data || [];

      // Update page title
      document.title = `${user.username} - Oscar 2026 Tracker`;

      // Calculate stats
      const watchedCount = watchedList.length;
      const ratedMovies = watchedList.filter(w => w.rating > 0);
      const avgRating = ratedMovies.length > 0
        ? (ratedMovies.reduce((sum, w) => sum + w.rating, 0) / ratedMovies.length).toFixed(1)
        : null;

      // Check if this is the current user
      const currentUser = getLocalUser();
      const isOwnProfile = currentUser && currentUser.id === user.id;

      function render() {
        content.innerHTML = `
          <a href="community.html" class="btn btn--secondary btn--sm mb-lg">&lt;- Back to Community</a>

          <div class="card mb-lg">
            <div class="flex flex-between flex-center mb-lg" style="flex-wrap: wrap; gap: 1rem;">
              <div class="flex gap-md flex-center">
                <div class="user-badge" style="width: 60px; height: 60px; font-size: 1.25rem; display: flex; align-items: center; justify-content: center;">
                  [${user.username.charAt(0).toUpperCase()}]
                </div>
                <div>
                  <h1 class="mb-sm">${user.username}</h1>
                  <p class="text-muted mb-0">Joined ${formatDate(user.created_at)}</p>
                </div>
              </div>
              ${isOwnProfile ? `
                <a href="profile.html" class="btn btn--outline btn--sm">Edit Profile</a>
              ` : ''}
            </div>

            <div class="stats-grid mb-0">
              <div class="stat-card">
                <div class="stat-card__value">${watchedCount}</div>
                <div class="stat-card__label">Watched</div>
              </div>
              <div class="stat-card">
                <div class="stat-card__value">${ratedMovies.length}</div>
                <div class="stat-card__label">Rated</div>
              </div>
              <div class="stat-card">
                <div class="stat-card__value">${avgRating || '-'}</div>
                <div class="stat-card__label">Avg Rating</div>
              </div>
            </div>
          </div>

          ${watchedCount > 0 ? `
            <h2 class="mb-lg">Watched Movies</h2>

            <div class="flex flex-between flex-center mb-lg" style="flex-wrap: wrap; gap: 1rem;">
              <p class="text-muted mb-0">${watchedCount} movie${watchedCount !== 1 ? 's' : ''} watched</p>
              <select id="sort-select" class="form-select" style="width: auto;">
                <option value="date">Recently Watched</option>
                <option value="rating">Highest Rated</option>
                <option value="title">Title A-Z</option>
              </select>
            </div>

            <div id="watched-list"></div>
          ` : `
            <div class="empty-state">
              <div class="empty-state__icon">[  ]</div>
              <h2 class="empty-state__title">No movies watched yet</h2>
              <p class="empty-state__text">${user.username} hasn't watched any movies yet.</p>
            </div>
          `}
        `;

        if (watchedCount > 0) {
          renderWatchedList('date');
          document.getElementById('sort-select').addEventListener('change', (e) => {
            renderWatchedList(e.target.value);
          });
        }
      }

      function renderWatchedList(sortBy) {
        const container = document.getElementById('watched-list');

        // Sort the list
        let sorted = [...watchedList];
        switch (sortBy) {
          case 'rating':
            sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            break;
          case 'title':
            sorted.sort((a, b) => {
              const movieA = getMovie(a.movie_id);
              const movieB = getMovie(b.movie_id);
              return (movieA?.title || '').localeCompare(movieB?.title || '');
            });
            break;
          default: // date
            sorted.sort((a, b) => new Date(b.watched_at) - new Date(a.watched_at));
        }

        container.innerHTML = sorted.map(entry => {
          const movie = getMovie(entry.movie_id);
          if (!movie) return '';

          const ratingDisplay = entry.rating
            ? '[' + '*'.repeat(entry.rating) + '-'.repeat(5 - entry.rating) + ']'
            : '[-----]';

          return `
            <div class="card mb-md" style="cursor: pointer;" onclick="navigateTo('movie.html', { id: '${movie.id}' })">
              <div class="flex gap-md" style="align-items: flex-start;">
                <div style="flex: 1; min-width: 0;">
                  <div class="flex flex-between" style="align-items: flex-start; gap: 1rem;">
                    <div style="min-width: 0;">
                      <h4 class="mb-sm">${movie.title}</h4>
                      <div class="mb-sm" style="font-size: 1.1rem; color: var(--gold);">${ratingDisplay}</div>
                      ${entry.note ? `<p class="text-muted mb-sm">"${entry.note}"</p>` : ''}
                      <p class="text-muted mb-0" style="font-size: 0.85rem;">
                        Watched: ${formatDate(entry.watched_at)}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      render();
    });
  </script>
</body>
</html>
